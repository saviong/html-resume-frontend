name: Deploy Frontend Resume to Azure Blob

on:
  push:
    branches: [master]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repo
      uses: actions/checkout@v4

    - name: Azure Login with Service Principal
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Upload to Azure Blob Storage
      uses: azure/cli@v1
      with:
        inlineScript: |
          echo "Uploading all files to Azure Blob Storage..."
          
          # Upload all files (excluding git and github folders)
          az storage blob upload-batch \
            --account-name ${{ secrets.AZURE_STORAGE_ACCOUNT }} \
            --destination '$web' \
            --source . \
            --auth-mode key \
            --account-key ${{ secrets.AZURE_STORAGE_KEY }} \
            --overwrite true
          
          echo "‚úÖ All files uploaded successfully!"

    - name: Purge Azure Front Door cache
      uses: azure/cli@v1
      with:
        inlineScript: |
          # Let the CLI auto-install missing extensions
          az config set extension.use_dynamic_install=yes_without_prompt

          # Install/update the extension that exposes `az afd`
          az extension add --name front-door --only-show-errors || az extension update --name front-door --only-show-errors

          # Purge the AFD endpoint cache
          az afd endpoint purge \
            --resource-group "${{ secrets.AZURE_RESOURCE_GROUP }}" \
            --profile-name  "${{ secrets.AZURE_CDN_PROFILE_NAME }}" \
            --endpoint-name "${{ secrets.AZURE_CDN_ENDPOINT }}" \
            --content-paths '/*'

    - name: Display deployment info
      run: |
        echo "üéâ Deployment completed successfully!"
        echo "üìù Files uploaded to storage account: ${{ secrets.AZURE_STORAGE_ACCOUNT }}"
        echo "üåê Your resume should now be available at your static website URL"